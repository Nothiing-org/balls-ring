rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isCreatingOwnUserDoc(userId) {
      return request.resource.data.id == userId;
    }

    function isNotChangingId() {
      return request.resource.data.id == resource.data.id;
    }

    function isCreatingValidProject(userId, projectId) {
      let incomingData = request.resource.data;
      return incomingData.userId == userId 
        && incomingData.id == projectId
        && incomingData.name is string
        && incomingData.croppedImageUri is string
        && incomingData.revealMode is string
        && incomingData.pixelsPerFollower is number
        && incomingData.maxPixelsCap is number
        && incomingData.randomSeed is number
        && incomingData.createdAt is string
        && incomingData.days is list
        && incomingData.days.size() == 0;
    }

    function isNotChangingProjectRelations() {
      return request.resource.data.userId == resource.data.userId && request.resource.data.id == resource.data.id;
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId) && isCreatingOwnUserDoc(userId);
      allow update: if isExistingOwner(userId) && isNotChangingId();
      allow delete: if isExistingOwner(userId);

      match /projects/{projectId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && isCreatingValidProject(userId, projectId);
        allow update: if isExistingOwner(userId) && isNotChangingProjectRelations();
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}
